<!DOCTYPE html>
<html lang="en" class="scroll-smooth">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>GATE CSE Preparation Tracker</title>
    
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=Outfit:wght@500;600;700;800&display=swap" rel="stylesheet">
    
    <script src="https://cdn.tailwindcss.com"></script>
    
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.9.2/dist/confetti.browser.min.js"></script>

    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: {
                        sans: ['Inter', 'sans-serif'],
                        display: ['Outfit', 'sans-serif'],
                    },
                    colors: {
                        brand: {
                            50: '#eef2ff',
                            100: '#e0e7ff',
                            500: '#6366f1',
                            600: '#4f46e5',
                            900: '#312e81',
                        }
                    },
                    animation: {
                        'fade-in': 'fadeIn 0.5s cubic-bezier(0.4, 0, 0.2, 1) forwards',
                        'slide-up': 'slideUp 0.5s cubic-bezier(0.4, 0, 0.2, 1) forwards',
                    },
                    keyframes: {
                        fadeIn: {
                            '0%': { opacity: '0' },
                            '100%': { opacity: '1' },
                        },
                        slideUp: {
                            '0%': { opacity: '0', transform: 'translateY(20px)' },
                            '100%': { opacity: '1', transform: 'translateY(0)' },
                        }
                    }
                }
            }
        }
    </script>

    <style>
        /* Custom Modern Scrollbar */
        ::-webkit-scrollbar { width: 8px; }
        ::-webkit-scrollbar-track { background: transparent; }
        ::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: #94a3b8; }

        body {
            background-color: #f8fafc;
            background-image: 
                radial-gradient(at 0% 0%, hsla(253,16%,7%,1) 0, transparent 50%), 
                radial-gradient(at 50% 0%, hsla(225,39%,30%,1) 0, transparent 50%), 
                radial-gradient(at 100% 0%, hsla(339,49%,30%,1) 0, transparent 50%);
            background-attachment: fixed;
            background-size: cover;
            color: #0f172a;
        }

        /* Glassmorphism Utilities */
        .glass {
            background: rgba(255, 255, 255, 0.85);
            backdrop-filter: blur(12px);
            -webkit-backdrop-filter: blur(12px);
            border: 1px solid rgba(255, 255, 255, 0.3);
        }

        /* Hide details marker */
        details > summary { list-style: none; }
        details > summary::-webkit-details-marker { display: none; }
        
        /* Smooth Details Accordion */
        details summary .arrow-icon { transition: transform 0.3s cubic-bezier(0.4, 0, 0.2, 1); }
        details[open] summary .arrow-icon { transform: rotate(180deg); }
        details[open] summary { border-bottom-color: transparent; }
        
        details .details-content {
            display: grid;
            grid-template-rows: 0fr;
            transition: grid-template-rows 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }
        details[open] .details-content { grid-template-rows: 1fr; }
        details .details-inner { overflow: hidden; }

        /* Progress Bar Animation */
        .progress-bar-fill { transition: width 0.8s cubic-bezier(0.34, 1.56, 0.64, 1); }

        /* Hide checkboxes, style labels */
        .pill-checkbox input:checked + div {
            background-color: #4f46e5;
            color: white;
            border-color: #4f46e5;
            box-shadow: 0 4px 6px -1px rgba(79, 70, 229, 0.3), 0 2px 4px -1px rgba(79, 70, 229, 0.06);
            transform: translateY(-1px);
        }
    </style>
</head>
<body class="min-h-screen text-slate-800 antialiased selection:bg-brand-500 selection:text-white pb-20">

    <div id="auth-screen" class="fixed inset-0 z- flex items-center justify-center transition-opacity duration-500 glass">
        <div id="initial-loader" class="flex flex-col items-center justify-center">
            <div class="text-6xl md:text-7xl animate-bounce mb-6 drop-shadow-2xl">üèÜ</div>
            <h2 class="text-2xl font-display font-bold text-slate-800 tracking-tight animate-pulse">Syncing Tracker...</h2>
        </div>

        <div id="auth-card" class="hidden w-full max-w-md p-8 m-4 bg-white rounded-3xl shadow-2xl border border-slate-100 text-center animate-slide-up">
            <div class="w-20 h-20 bg-amber-50 rounded-3xl flex items-center justify-center mx-auto mb-6 -rotate-6 shadow-inner border border-amber-100 transition-transform hover:rotate-0 duration-300">
                <span class="text-5xl drop-shadow-md">üèÜ</span>
            </div>
            <h1 class="text-3xl font-display font-extrabold text-slate-900 mb-2">GATE CSE Tracker</h1>
            <p class="text-slate-500 mb-8 leading-relaxed">Your modern companion to conquer the GATE syllabus. Sign in to sync your progress.</p>
            
            <button id="login-btn" class="w-full relative group bg-white border-2 border-slate-200 hover:border-brand-500 hover:bg-slate-50 text-slate-700 font-semibold py-3.5 px-6 rounded-xl flex items-center justify-center space-x-3 transition-all duration-200">
                <svg class="w-5 h-5" viewBox="0 0 48 48"><path fill="#FFC107" d="M43.611,20.083H42V20H24v8h11.303c-1.649,4.657-6.08,8-11.303,8c-6.627,0-12-5.373-12-12c0-6.627,5.373-12,12-12c3.059,0,5.842,1.154,7.961,3.039l5.657-5.657C34.046,6.053,29.268,4,24,4C12.955,4,4,12.955,4,24s8.955,20,20,20s20-8.955,20-20C44,22.659,43.862,21.35,43.611,20.083z"/><path fill="#FF3D00" d="M6.306,14.691l6.571,4.819C14.655,15.108,18.961,12,24,12c3.059,0,5.842,1.154,7.961,3.039l5.657-5.657C34.046,6.053,29.268,4,24,4C16.318,4,9.656,8.337,6.306,14.691z"/><path fill="#4CAF50" d="M24,44c5.166,0,9.86-1.977,13.409-5.192l-6.19-5.238C29.211,35.091,26.715,36,24,36c-5.222,0-9.619-3.317-11.283-7.946l-6.522,5.025C9.505,39.556,16.227,44,24,44z"/><path fill="#1976D2" d="M43.611,20.083H42V20H24v8h11.303c-0.792,2.237-2.231,4.166-4.087,5.574l6.19,5.238C39.99,36.59,44,31.016,44,24C44,22.659,43.862,21.35,43.611,20.083z"/></svg>
                <span>Continue with Google</span>
            </button>
        </div>
    </div>

    <div id="app-container" class="max-w-6xl mx-auto px-4 sm:px-6 lg:px-8 pt-8 hidden animate-fade-in relative z-10">
        
        <header class="flex flex-col md:flex-row justify-between items-center gap-6 mb-10 z-50">
            <div class="flex items-center gap-4">
                <div class="w-12 h-12 bg-gradient-to-br from-brand-500 to-purple-600 rounded-2xl flex items-center justify-center shadow-lg shadow-brand-500/30 text-white">
                    <svg class="w-6 h-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 10V3L4 14h7v7l9-11h-7z" />
                    </svg>
                </div>
                <div>
                    <div class="flex items-center">
                        <h1 class="text-2xl md:text-3xl font-display font-bold text-white tracking-tight drop-shadow-md">GATE CSE Tracker</h1>
                        <div id="network-status" class="hidden ml-3 px-2 py-0.5 rounded text-[10px] font-bold uppercase tracking-wider bg-rose-500 text-white shadow-sm flex items-center gap-1 transition-all">
                            <svg class="w-3 h-3" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M18.364 5.636a9 9 0 010 12.728m0 0l-2.829-2.829m2.829 2.829L21 21M15.536 8.464a5 5 0 010 7.072m0 0l-2.829-2.829m-4.243 2.829a4.978 4.978 0 01-1.414-2.83m-1.414 5.658a9 9 0 01-2.167-9.238m7.824 2.167a1 1 0 111.414 1.414m-1.414-1.414L3 3m8.293 8.293l1.414 1.414" /></svg>
                            Offline Mode
                        </div>
                    </div>
                    <p class="text-sm font-medium text-brand-100 mt-0.5">Master the syllabus, systematically.</p>
                </div>
            </div>

            <div class="relative group">
                <div id="user-profile-trigger" class="flex items-center gap-2 glass pl-2 pr-4 py-1.5 rounded-full cursor-pointer hover:bg-white/95 transition-colors shadow-sm">
                    <div id="user-profile-img-container" class="flex items-center justify-center">
                        <div class="w-10 h-10 rounded-full bg-slate-200 animate-pulse"></div>
                    </div>
                </div>
                
                <div id="profile-dropdown" class="absolute right-0 top-full mt-2 w-56 bg-white rounded-2xl shadow-xl border border-slate-100 opacity-0 pointer-events-none transition-all duration-200 transform origin-top-right scale-95 z-50 overflow-hidden">
                    <div class="p-3 border-b border-slate-100 bg-slate-50/50">
                        <p class="text-xs text-slate-500 font-medium mb-1">Signed in as</p>
                        <p id="dropdown-user-name" class="text-sm font-bold text-slate-800 truncate">Loading...</p>
                    </div>
                    <div class="p-2">
                        <button id="guide-btn" class="w-full text-left px-3 py-2.5 text-sm font-medium text-slate-700 hover:bg-brand-50 hover:text-brand-600 rounded-lg transition-colors flex items-center gap-3">
                            <div class="p-1.5 rounded-md bg-slate-100 text-slate-500"><svg class="w-4 h-4" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" /></svg></div>
                            Preparation Guide
                        </button>
                        <button id="reset-btn" class="w-full text-left px-3 py-2.5 text-sm font-medium text-rose-600 hover:bg-rose-50 rounded-lg transition-colors flex items-center gap-3 mt-1">
                            <div class="p-1.5 rounded-md bg-rose-100 text-rose-500"><svg class="w-4 h-4" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" /></svg></div>
                            Reset Progress
                        </button>
                    </div>
                    <div class="p-2 border-t border-slate-100">
                        <button id="logout-btn" class="w-full text-left px-3 py-2.5 text-sm font-medium text-slate-700 hover:bg-slate-50 rounded-lg transition-colors flex items-center gap-3">
                            <div class="p-1.5 rounded-md bg-slate-100 text-slate-500"><svg class="w-4 h-4" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 16l4-4m0 0l-4-4m4 4H7m6 4v1a3 3 0 01-3 3H6a3 3 0 01-3-3V7a3 3 0 013-3h4a3 3 0 013 3v1" /></svg></div>
                            Sign Out
                        </button>
                    </div>
                </div>
            </div>
        </header>

        <main class="glass rounded-3xl shadow-2xl overflow-hidden mb-12">
            
            <div class="sticky top-0 z-40 bg-white/80 backdrop-blur-xl border-b border-slate-200/60 p-6 md:px-8">
                <div class="flex flex-col md:flex-row md:items-center justify-between gap-6">
                    
                    <div class="flex bg-slate-100/80 p-1.5 rounded-xl border border-slate-200/50 w-full md:w-auto overflow-x-auto">
                        <button id="tab-syllabus" class="flex-1 md:flex-none whitespace-nowrap text-sm font-semibold py-2.5 px-6 rounded-lg bg-white text-brand-600 shadow-sm transition-all duration-200">
                            Syllabus Flow
                        </button>
                        <button id="tab-dashboard" class="flex-1 md:flex-none whitespace-nowrap text-sm font-semibold py-2.5 px-6 rounded-lg text-slate-500 hover:text-slate-700 hover:bg-white/50 transition-all duration-200">
                            Analytics
                        </button>
                        <button id="tab-marks" class="flex-1 md:flex-none whitespace-nowrap text-sm font-semibold py-2.5 px-6 rounded-lg text-slate-500 hover:text-slate-700 hover:bg-white/50 transition-all duration-200">
                            Marks Distribution
                        </button>
                    </div>

                    <div class="flex-1 max-w-md w-full">
                        <div class="flex justify-between items-end mb-2">
                            <span class="text-sm font-bold text-slate-700">Overall Completion</span>
                            <span id="overall-progress-text" class="text-2xl font-display font-extrabold text-brand-600">0%</span>
                        </div>
                        <div class="h-3 w-full bg-slate-100 rounded-full overflow-hidden border border-slate-200 inset-shadow">
                            <div id="overall-progress" class="h-full bg-gradient-to-r from-brand-500 to-purple-500 progress-bar-fill rounded-full relative shadow-[0_0_10px_rgba(79,70,229,0.4)]" style="width: 0%;">
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="p-6 md:p-8">
                <div id="syllabus-content" class="space-y-6"></div>

                <div id="dashboard-content" class="hidden space-y-8">
                    <div class="grid grid-cols-2 md:grid-cols-4 gap-4 md:gap-6">
                        <div class="bg-white rounded-2xl p-5 border border-slate-100 shadow-sm hover:shadow-md transition-shadow">
                            <div class="w-10 h-10 rounded-full bg-blue-50 text-blue-600 flex items-center justify-center mb-4">
                                <svg class="w-5 h-5" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z" /></svg>
                            </div>
                            <p class="text-sm font-medium text-slate-500">Syllabus Coverage</p>
                            <h4 id="metric-total-completion" class="text-3xl font-display font-bold text-slate-800 mt-1">0%</h4>
                        </div>
                        <div class="bg-white rounded-2xl p-5 border border-brand-100 shadow-sm hover:shadow-md transition-shadow bg-brand-50/30">
                            <div class="w-10 h-10 rounded-full bg-brand-100 text-brand-600 flex items-center justify-center mb-4">
                                <svg class="w-5 h-5" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 7h8m0 0v8m0-8l-8 8-4-4-6 6" /></svg>
                            </div>
                            <p class="text-sm font-medium text-brand-700">Projected Score</p>
                            <div class="flex items-baseline gap-1 mt-1">
                                <h4 id="metric-projected-score" class="text-3xl font-display font-bold text-brand-700">0</h4>
                                <span class="text-sm font-semibold text-brand-600/70">/ 100</span>
                            </div>
                        </div>
                        <div class="bg-white rounded-2xl p-5 border border-slate-100 shadow-sm hover:shadow-md transition-shadow">
                            <div class="w-10 h-10 rounded-full bg-purple-50 text-purple-600 flex items-center justify-center mb-4">
                                <svg class="w-5 h-5" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m5.618-4.016A11.955 11.955 0 0112 2.944a11.955 11.955 0 01-8.618 3.04A12.02 12.02 0 003 9c0 5.591 3.824 10.29 9 11.622 5.176-1.332 9-6.03 9-11.622 0-1.042-.133-2.052-.382-3.016z" /></svg>
                            </div>
                            <p class="text-sm font-medium text-slate-500">Topics Mastered</p>
                            <h4 id="metric-topics-completed" class="text-3xl font-display font-bold text-slate-800 mt-1">0</h4>
                        </div>
                        <div class="bg-white rounded-2xl p-5 border border-slate-100 shadow-sm hover:shadow-md transition-shadow">
                            <div class="w-10 h-10 rounded-full bg-orange-50 text-orange-600 flex items-center justify-center mb-4">
                                <svg class="w-5 h-5" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h5V4H4zm0 0L2 2m2 2l2-2m0 12v5h5v-5h-5zm0 0l-2 2m2-2l2 2M15 4v5h5V4h-5zm0 0l-2-2m2 2l2-2m0 12v5h5v-5h-5zm0 0l-2 2m2-2l2 2" /></svg>
                            </div>
                            <p class="text-sm font-medium text-slate-500">Total Revisions</p>
                            <h4 id="metric-revisions-done" class="text-3xl font-display font-bold text-slate-800 mt-1">0</h4>
                        </div>
                    </div>

                    <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                        <div class="bg-white rounded-3xl p-6 border border-slate-100 shadow-sm">
                            <h3 class="text-lg font-display font-bold text-slate-800 mb-6">Subject Strengths</h3>
                            <div class="relative h-[300px] w-full">
                                <canvas id="radarChart"></canvas>
                            </div>
                        </div>
                        <div class="bg-white rounded-3xl p-6 border border-slate-100 shadow-sm">
                            <div class="flex justify-between items-center mb-6">
                                <h3 class="text-lg font-display font-bold text-slate-800">Phase Bottlenecks</h3>
                                <span class="text-xs font-semibold px-2 py-1 bg-slate-100 text-slate-500 rounded-md">Stacked View</span>
                            </div>
                            <div class="relative h-[300px] w-full">
                                <canvas id="barChart"></canvas>
                            </div>
                        </div>
                    </div>
                </div>

                <div id="marks-content" class="hidden space-y-6">
                    <div class="bg-white rounded-3xl p-6 md:p-8 border border-slate-100 shadow-sm">
                        <div class="mb-6 flex flex-col md:flex-row md:items-end justify-between gap-4">
                            <div>
                                <h2 class="text-xl md:text-2xl font-display font-bold text-slate-800">Historical Marks Distribution</h2>
                                <p class="text-slate-500 text-sm mt-1">Based on GATE CSE papers (2010 - 2025). Core subjects only (85 Marks).</p>
                            </div>
                            <div class="flex items-center gap-3">
                                <div class="flex bg-slate-100 p-1.5 rounded-xl border border-slate-200/50">
                                    <button id="toggle-average" class="px-4 py-1.5 text-sm font-semibold rounded-lg bg-white text-brand-600 shadow-sm transition-all duration-200">
                                        Average
                                    </button>
                                    <button id="toggle-median" class="px-4 py-1.5 text-sm font-semibold rounded-lg text-slate-500 hover:text-slate-700 transition-all duration-200">
                                        Median
                                    </button>
                                </div>
                                <div class="hidden sm:flex bg-slate-50 text-slate-600 px-4 py-2 rounded-xl text-sm font-bold border border-slate-100 items-center gap-2">
                                    <svg class="w-4 h-4" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 4h13M3 8h9m-9 4h6m4 0l4-4m0 0l4 4m-4-4v12" /></svg>
                                    Ranked
                                </div>
                            </div>
                        </div>
                        <div class="overflow-x-auto">
                            <table class="w-full text-left border-collapse min-w-[500px]">
                                <thead>
                                    <tr class="border-b-2 border-slate-200 text-sm font-semibold text-slate-500">
                                        <th class="pb-3 pl-2">Subject</th>
                                        <th class="pb-3 text-right pr-4 w-24">Weightage</th>
                                        <th class="pb-3 w-1/2">Proportion</th>
                                    </tr>
                                </thead>
                                <tbody id="marks-table-body"></tbody>
                            </table>
                        </div>
                    </div>

                    <div class="bg-white rounded-3xl p-6 md:p-8 border border-slate-100 shadow-sm mt-6 animate-slide-up" style="animation-delay: 100ms;">
                        <div class="mb-6 flex flex-col md:flex-row md:items-end justify-between gap-4">
                            <div>
                                <h2 class="text-xl md:text-2xl font-display font-bold text-slate-800">Deep Dive: Subject Trends</h2>
                                <p class="text-slate-500 text-sm mt-1">Analyze how the weightage of each subject has shifted over the last 11 exams.</p>
                            </div>
                            <div class="relative w-full md:w-64">
                                <select id="trend-subject-select" class="w-full appearance-none bg-slate-50 border border-slate-200 text-slate-700 font-semibold py-2.5 px-4 pr-8 rounded-xl focus:outline-none focus:ring-2 focus:ring-brand-500 focus:border-brand-500 transition-colors cursor-pointer"></select>
                                <div class="pointer-events-none absolute inset-y-0 right-0 flex items-center px-3 text-slate-500">
                                    <svg class="w-4 h-4" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"/></svg>
                                </div>
                            </div>
                        </div>

                        <div class="grid grid-cols-3 gap-4 mb-6">
                            <div class="bg-slate-50 rounded-2xl p-4 border border-slate-100">
                                <p class="text-xs font-semibold text-slate-400 uppercase tracking-wider mb-1">Highest Marks</p>
                                <h4 id="insight-max" class="text-2xl font-display font-bold text-brand-600">0</h4>
                            </div>
                            <div class="bg-slate-50 rounded-2xl p-4 border border-slate-100">
                                <p class="text-xs font-semibold text-slate-400 uppercase tracking-wider mb-1">Lowest Marks</p>
                                <h4 id="insight-min" class="text-2xl font-display font-bold text-rose-500">0</h4>
                            </div>
                            <div class="bg-slate-50 rounded-2xl p-4 border border-slate-100">
                                <p class="text-xs font-semibold text-slate-400 uppercase tracking-wider mb-1">Volatility</p>
                                <h4 id="insight-volatility" class="text-lg md:text-xl font-display font-bold text-slate-700">Stable</h4>
                            </div>
                        </div>

                        <div class="relative h-[300px] w-full mt-4">
                            <canvas id="trendLineChart"></canvas>
                        </div>
                    </div>
                </div>

            </div>
        </main>
    </div>

    <div id="reset-modal" class="fixed inset-0 z- bg-slate-900/40 backdrop-blur-sm flex items-center justify-center opacity-0 pointer-events-none transition-opacity duration-300">
        <div class="bg-white rounded-3xl p-8 max-w-sm w-full mx-4 shadow-2xl transform scale-95 transition-transform duration-300" id="reset-modal-content">
            <div class="w-16 h-16 bg-rose-100 text-rose-600 rounded-full flex items-center justify-center mb-6 mx-auto">
                <svg class="w-8 h-8" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z" /></svg>
            </div>
            <h3 class="text-2xl font-display font-bold text-center text-slate-800 mb-2">Reset Progress?</h3>
            <p class="text-center text-slate-500 mb-8 leading-relaxed">This will permanently erase all your checked topics. This action cannot be undone.</p>
            <div class="flex flex-col gap-3">
                <button id="confirm-reset" class="w-full bg-rose-500 hover:bg-rose-600 text-white font-semibold py-3 rounded-xl transition-colors shadow-sm">Yes, Reset Everything</button>
                <button id="cancel-reset" class="w-full bg-slate-100 hover:bg-slate-200 text-slate-700 font-semibold py-3 rounded-xl transition-colors">Cancel</button>
            </div>
        </div>
    </div>

    <div id="guide-modal" class="fixed inset-0 z- bg-slate-900/40 backdrop-blur-sm flex items-center justify-center opacity-0 pointer-events-none transition-opacity duration-300">
        <div class="bg-white rounded-3xl p-6 md:p-8 max-w-xl w-full mx-4 shadow-2xl transform scale-95 transition-transform duration-300 max-h-[90vh] overflow-y-auto" id="guide-modal-content">
            <div class="flex justify-between items-center mb-6">
                <div class="flex items-center gap-3">
                    <div class="w-10 h-10 rounded-xl bg-brand-50 flex items-center justify-center text-brand-600">
                        <svg class="w-5 h-5" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" /></svg>
                    </div>
                    <h3 class="text-2xl font-display font-bold text-slate-800">Preparation Guide</h3>
                </div>
                <button id="close-guide" class="text-slate-400 hover:text-slate-600 transition-colors bg-slate-100 hover:bg-slate-200 p-2 rounded-full">
                    <svg class="w-5 h-5" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" /></svg>
                </button>
            </div>
            <div class="text-slate-600 space-y-4 text-sm md:text-base leading-relaxed">
                <p>This tracker uses scientifically proven <strong>spaced repetition</strong> to help you master the GATE syllabus systematically.</p>
                <ul class="space-y-4 mt-6">
                    <li class="flex gap-4 p-3 bg-slate-50 rounded-xl border border-slate-100"><span class="flex-shrink-0 w-10 h-10 bg-white rounded-lg border border-slate-200 font-bold text-slate-600 flex items-center justify-center shadow-sm">N</span><div><strong class="text-slate-800">Notes & Concepts</strong></div></li>
                    <li class="flex gap-4 p-3 bg-slate-50 rounded-xl border border-slate-100"><span class="flex-shrink-0 w-10 h-10 bg-white rounded-lg border border-slate-200 font-bold text-brand-600 flex items-center justify-center shadow-sm">R1</span><div><strong class="text-slate-800">First Revision</strong></div></li>
                    <li class="flex gap-4 p-3 bg-slate-50 rounded-xl border border-slate-100"><span class="flex-shrink-0 w-10 h-10 bg-white rounded-lg border border-slate-200 font-bold text-purple-600 flex items-center justify-center shadow-sm">TT</span><div><strong class="text-slate-800">Topic Test</strong></div></li>
                    <li class="flex gap-4 p-3 bg-slate-50 rounded-xl border border-slate-100"><span class="flex-shrink-0 w-10 h-10 bg-white rounded-lg border border-slate-200 font-bold text-orange-500 flex items-center justify-center shadow-sm">P1</span><div><strong class="text-slate-800">PYQ Iteration 1</strong></div></li>
                    <li class="flex gap-4 p-3 bg-slate-50 rounded-xl border border-slate-100"><span class="flex-shrink-0 w-10 h-10 bg-white rounded-lg border border-slate-200 font-bold text-brand-600 flex items-center justify-center shadow-sm">R2</span><div><strong class="text-slate-800">Second Revision</strong></div></li>
                    <li class="flex gap-4 p-3 bg-slate-50 rounded-xl border border-slate-100"><span class="flex-shrink-0 w-10 h-10 bg-white rounded-lg border border-slate-200 font-bold text-orange-500 flex items-center justify-center shadow-sm">P2</span><div><strong class="text-slate-800">PYQ Iteration 2</strong></div></li>
                    <li class="flex gap-4 p-3 bg-slate-50 rounded-xl border border-slate-100"><span class="flex-shrink-0 w-10 h-10 bg-white rounded-lg border border-slate-200 font-bold text-brand-600 flex items-center justify-center shadow-sm">R3</span><div><strong class="text-slate-800">Final Sweep Revision</strong></div></li>
                </ul>
            </div>
            <button id="got-it-btn" class="mt-8 w-full bg-brand-600 hover:bg-brand-700 text-white font-semibold py-3.5 rounded-xl transition-colors shadow-sm text-lg">Let's Get Started</button>
        </div>
    </div>
    
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
        import { getFirestore, doc, onSnapshot, setDoc } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";
        import { getAuth, GoogleAuthProvider, signInWithPopup, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";
        
        // --- FIREBASE CONFIG ---
        const firebaseConfig = {
            apiKey: "AIzaSyBVUTqPzWbMEzzdWbdQUY806SadUWvmUz8",
            authDomain: "gate-tracker-a561f.firebaseapp.com",
            projectId: "gate-tracker-a561f",
            storageBucket: "gate-tracker-a561f.firebasestorage.app",
            messagingSenderId: "322542809047",
            appId: "1:322542809047:web:86e719394ca02b6ef32592",
            measurementId: "G-2MBR978R7G"
        };
        
        // Initialize Firebase immediately 
        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const auth = getAuth(app);
        const provider = new GoogleAuthProvider();

        const syllabus = {
            "Computer Networks": ["IPV4 Addressing", "Error Control", "Flow Control", "IPV4 Header & Fragmentation", "TCP & UDP", "Medium Access Control", "Routing Protocols", "Switching", "Application Layer Protocols", "IP Support protocol", "OSI & TCP Stack"],
            "Operating Systems": ["Introduction & Background", "Process Management", "CPU Scheduling", "Process Synchronization", "DeadLock", "Memory Management", "File Sys & Device Management", "System Calls & Threads"],
            "C-Programming": ["Data Types & Operators", "Control Flow Statements", "Functions & Storage Classes", "Arrays & Pointers", "Strings", "Structures & Union", "Miscellaneous"],
            "Data Structures": ["Introduction", "Arrays", "Linked List", "Stack & Queues", "Trees", "Graphs", "Hashing"],
            "Digital Logic": ["Logic Gates", "Minimization", "Combinational Circuit", "Sequential Circuit", "Number System"],
            "Theory of Computation": ["Finite Automata", "Push down Automata", "Turing Machine", "Decidability"],
            "Compiler Design": ["Lexical & Syntax Analysis", "Syntax Directed Translation", "Intermediate Code & Optimization"],
            "Algorithms": ["Analysis Of Algorithms", "Design Strategies", "Greedy Method", "Dynamic Programming", "Graph Algorithms", "Heap Algorithms", "Backtracking & Branch Bound"],
            "DBMS": ["FD's and Normalisation", "Transaction & Concurrency", "ER Model", "Query Language", "File Organisation & Indexing"],
            "Computer Architecture": ["Introduction", "Machine Instruction & Addressing", "Floating Point Representation", "ALU and Control Unit", "Instruction And Pipelining", "Cache Memory", "Secondary Memory & IO"],
            "Discrete Mathematics": ["Graph Theory", "Mathematical Logic", "Set Theory", "Combinatorics"],
            "Engineering Mathematics": ["Linear Algebra", "Calculus", "Probability & Statistics"],
            "General Aptitude": ["Verbal Aptitude", "Quantitative Aptitude", "Analytical Aptitude", "Spatial Aptitude"]
        };
        
        const subjectAbbreviations = {
            "Computer Networks": "CN", "Operating Systems": "OS", "C-Programming": "C Prog", 
            "Data Structures": "DS", "Digital Logic": "DL", "Theory of Computation": "TOC", 
            "Compiler Design": "CD", "Algorithms": "Algo", "DBMS": "DBMS", 
            "Computer Architecture": "COA", "Discrete Mathematics": "DM", 
            "Engineering Mathematics": "EM", "General Aptitude": "GA"
        };
        
        const subjectWeightages = {
            "Computer Networks": 7.9, "Operating Systems": 8.7, "C-Programming": 4.4, "Data Structures": 4.5,
            "Digital Logic": 6.2, "Theory of Computation": 7.7, "Compiler Design": 5.6, "Algorithms": 9.2,
            "DBMS": 7.2, "Computer Architecture": 7.0, "Discrete Mathematics": 9.2, "Engineering Mathematics": 7.4,
            "General Aptitude": 15.0
        };

        const subjectMedians = {
            "Computer Networks": 8.0, "Operating Systems": 9.0, "C-Programming": 4.0, "Data Structures": 5.0,
            "Digital Logic": 6.0, "Theory of Computation": 8.0, "Compiler Design": 6.0, "Algorithms": 9.0,
            "DBMS": 8.0, "Computer Architecture": 7.0, "Discrete Mathematics": 9.0, "Engineering Mathematics": 6.0,
            "General Aptitude": 15.0
        };
        
        const trendLabels = ['2018', '2019', '2020', '2021-1', '2021-2', '2022', '2023', '2024-1', '2024-2', '2025-1', '2025-2'];
        const trendData = {
            "Computer Networks":, "Operating Systems":,
            "C-Programming":, "Data Structures":,
            "Digital Logic":, "Theory of Computation":,
            "Compiler Design":, "Algorithms":,
            "DBMS":, "Computer Architecture":,
            "Discrete Mathematics":, "Engineering Mathematics":,
            "General Aptitude":
        };

        let currentMarksMetric = 'average';
        let trendLineChart;
        
        const columns = [
            { label: 'N', tooltip: 'Notes', id: 'notes' }, { label: 'R1', tooltip: 'Revision 1', id: 'r1' },
            { label: 'R2', tooltip: 'Revision 2', id: 'r2' }, { label: 'R3', tooltip: 'Revision 3', id: 'r3' },
            { label: 'TT', tooltip: 'Topic Test', id: 'tt' }, { label: 'P1', tooltip: 'PYQ Set 1', id: 'pyq1' },
            { label: 'P2', tooltip: 'PYQ Set 2', id: 'pyq2' }
        ];
        
        const container = document.getElementById('syllabus-content');
        let totalCheckboxes = 0;
        let checkboxStates = {};
        let radarChart, barChart;
        let unsubscribe;
        let currentUser = null;
        const subjectCompletionState = {};
        const LOCAL_STORAGE_KEY = 'gateTrackerState_offline';

        const getUserDocRef = (uid) => doc(db, 'users', uid, 'progress', 'state');

        function generateSyllabusHTML() {
             let delay = 0;
            for (const subject in syllabus) {
                const subjectId = subject.replace(/\s+/g, '-').toLowerCase();
                subjectCompletionState[subjectId] = false;
                
                const detailsElement = document.createElement('details');
                detailsElement.className = 'group bg-white rounded-2xl border border-slate-200 shadow-sm hover:shadow-md transition-shadow overflow-hidden';
                detailsElement.style.animationDelay = `${delay}ms`;
                delay += 50;
                
                let subjectHTML = `
                    <summary class="p-5 cursor-pointer flex flex-col md:flex-row justify-between items-center gap-4 select-none relative z-10 bg-white">
                        <div class="flex items-center space-x-4 w-full md:w-auto">
                            <div class="w-10 h-10 rounded-xl bg-brand-50 flex items-center justify-center text-brand-600 transition-colors group-hover:bg-brand-100 shrink-0">
                                <svg id="icon-${subjectId}" class="w-5 h-5 opacity-0 scale-50 transition-all duration-300 absolute text-green-500" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="3"><path stroke-linecap="round" stroke-linejoin="round" d="M5 13l4 4L19 7"/></svg>
                                <svg class="w-5 h-5 folder-icon transition-all duration-300" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 7v10a2 2 0 002 2h14a2 2 0 002-2V9a2 2 0 00-2-2h-6l-2-2H5a2 2 0 00-2 2z"/></svg>
                            </div>
                            <h2 class="text-lg font-display font-bold text-slate-800 flex-1">${subject}</h2>
                        </div>
                        
                        <div class="w-full md:w-[300px] flex items-center space-x-4">
                            <div class="flex-grow h-2.5 bg-slate-100 rounded-full overflow-hidden border border-slate-200 inset-shadow">
                                <div id="progress-${subjectId}" class="h-full bg-brand-500 progress-bar-fill rounded-full" style="width: 0%;"></div>
                            </div>
                            <span id="progress-text-${subjectId}" class="text-sm font-bold text-slate-600 w-10 text-right">0%</span>
                            <div class="w-8 h-8 rounded-full bg-slate-50 flex items-center justify-center shrink-0">
                                <svg class="w-4 h-4 text-slate-400 arrow-icon" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"/></svg>
                            </div>
                        </div>
                    </summary>
                    
                    <div class="details-content bg-slate-50/50">
                        <div class="details-inner p-2 md:p-5 border-t border-slate-100">
                            <div class="space-y-2">
                `;

                syllabus[subject].forEach((item, index) => {
                    const itemId = `${subjectId}-${item.replace(/[^a-zA-Z0-9]/g, '-').toLowerCase()}-${index}`;
                    totalCheckboxes += columns.length;
                    
                    subjectHTML += `
                        <div class="bg-white p-4 rounded-xl border border-slate-200 shadow-sm flex flex-col md:flex-row md:items-center justify-between gap-4 hover:border-brand-300 transition-colors">
                            <span class="text-sm font-semibold text-slate-700 md:w-1/3 leading-snug">${item}</span>
                            <div class="flex flex-wrap md:flex-nowrap gap-2 md:gap-3 shrink-0">
                                ${columns.map(col => `
                                    <label class="pill-checkbox cursor-pointer" title="${col.tooltip}">
                                        <input type="checkbox" class="hidden custom-checkbox" id="${itemId}-${col.id}" data-subject="${subjectId}">
                                        <div class="w-10 h-10 md:w-11 md:h-11 rounded-xl flex items-center justify-center text-xs font-bold text-slate-400 bg-slate-100 border border-slate-200 transition-all duration-200 hover:bg-slate-200 select-none">
                                            ${col.label}
                                        </div>
                                    </label>
                                `).join('')}
                            </div>
                        </div>
                    `;
                });

                subjectHTML += `</div></div></div>`;
                detailsElement.innerHTML = subjectHTML;
                container.appendChild(detailsElement);
            }
        }

        function generateMarksTable() {
            const tbody = document.getElementById('marks-table-body');
            const sourceData = currentMarksMetric === 'average' ? subjectWeightages : subjectMedians;
            
            const sortedSubjects = Object.entries(sourceData)
                .filter(([subject]) => subject !== "General Aptitude")
                .sort((a, b) => b - a);

            let html = '';
            const maxWeight = Math.max(...sortedSubjects.map(s => s)); 
            const barColorClass = currentMarksMetric === 'average' ? 'from-brand-500 to-brand-600' : 'from-purple-400 to-purple-500';

            sortedSubjects.forEach(([subject, weight]) => {
                const widthPercent = (weight / maxWeight) * 100;
                html += `
                    <tr class="border-b border-slate-100 last:border-0 hover:bg-slate-50 transition-colors group">
                        <td class="py-4 pl-2 font-medium text-slate-700 group-hover:text-brand-600 transition-colors">${subject}</td>
                        <td class="py-4 text-right pr-4 font-bold text-slate-800">${weight.toFixed(1)}</td>
                        <td class="py-4 w-1/2 pr-2">
                            <div class="h-2.5 w-full bg-slate-100 rounded-full overflow-hidden flex">
                                <div class="h-full bg-gradient-to-r ${barColorClass} rounded-full shadow-sm transition-all duration-500 ease-out" style="width: ${widthPercent}%"></div>
                            </div>
                        </td>
                    </tr>
                `;
            });
            tbody.innerHTML = html;
        }

        function initTrendAnalytics() {
            const select = document.getElementById('trend-subject-select');
            let optionsHtml = '';
            Object.keys(subjectAbbreviations).forEach(subj => {
                if (subj !== "General Aptitude") {
                    optionsHtml += `<option value="${subj}">${subj}</option>`;
                }
            });
            select.innerHTML = optionsHtml;
            select.value = "Algorithms";
            updateTrendChart("Algorithms");

            select.addEventListener('change', (e) => {
                updateTrendChart(e.target.value);
            });
        }

        function updateTrendChart(subject) {
            const data = trendData[subject];
            
            const max = Math.max(...data);
            const min = Math.min(...data);
            const diff = max - min;
            
            let volatilityText = "Stable";
            if (diff === 0) volatilityText = "Constant";
            else if (diff <= 2) volatilityText = "Low";
            else if (diff <= 5) volatilityText = "Moderate";
            else volatilityText = "High / Unpredictable";

            document.getElementById('insight-max').textContent = max;
            document.getElementById('insight-min').textContent = min;
            document.getElementById('insight-volatility').textContent = volatilityText;

            if (trendLineChart) {
                trendLineChart.data.datasets.data = data;
                trendLineChart.data.datasets.label = `${subject} Marks Trend`;
                trendLineChart.update();
            }
        }

        function initCharts() {
            try {
                if (typeof Chart === 'undefined') return;

                const chartLabels = Object.keys(syllabus).map(s => subjectAbbreviations[s] || s);
                const brandColor = 'rgba(99, 102, 241, 1)'; 
                const brandBg = 'rgba(99, 102, 241, 0.2)';

                Chart.defaults.font.family = "'Inter', sans-serif";
                Chart.defaults.color = '#64748b';

                const radarCtx = document.getElementById('radarChart').getContext('2d');
                radarChart = new Chart(radarCtx, {
                    type: 'radar',
                    data: { labels: chartLabels, datasets: [{ data: [], backgroundColor: brandBg, borderColor: brandColor, borderWidth: 2, pointBackgroundColor: brandColor, pointBorderColor: '#fff', pointHoverBackgroundColor: '#fff', pointHoverBorderColor: brandColor, fill: true }] },
                    options: { 
                        responsive: true, maintainAspectRatio: false, 
                        scales: { 
                            r: { 
                                beginAtZero: true, max: 100, 
                                ticks: { stepSize: 25, display: false },
                                pointLabels: { font: { size: 12, family: "'Outfit', sans-serif", weight: '700' }, color: '#475569' },
                                grid: { color: 'rgba(0, 0, 0, 0.05)' },
                                angleLines: { color: 'rgba(0, 0, 0, 0.05)' }
                            } 
                        }, 
                        plugins: { legend: { display: false }, tooltip: { backgroundColor: 'rgba(15, 23, 42, 0.9)', padding: 12, cornerRadius: 8, displayColors: false, callbacks: { label: (ctx) => `${ctx.raw}% Completed` } } } 
                    }
                });

                const barCtx = document.getElementById('barChart').getContext('2d');
                barChart = new Chart(barCtx, {
                    type: 'bar',
                    data: { 
                        labels: chartLabels, 
                        datasets: [
                            { label: 'Notes', data: [], backgroundColor: 'rgba(59, 130, 246, 0.9)', borderRadius: 4 },
                            { label: 'Practice', data: [], backgroundColor: 'rgba(249, 115, 22, 0.9)', borderRadius: 4 },
                            { label: 'Revision', data: [], backgroundColor: 'rgba(16, 185, 129, 0.9)', borderRadius: 4 }
                        ] 
                    },
                    options: { 
                        responsive: true, maintainAspectRatio: false, 
                        scales: { 
                            x: { stacked: true, grid: { display: false, drawBorder: false }, ticks: { font: { size: 11, weight: '600' }, color: '#475569', maxRotation: 45, minRotation: 45 } },
                            y: { stacked: true, beginAtZero: true, max: 100, grid: { color: 'rgba(0,0,0,0.05)', drawBorder: false }, ticks: { font: { size: 12, weight: '600' }, color: '#475569', stepSize: 25, callback: (val) => val + '%' } }
                        }, 
                        plugins: { 
                            legend: { display: true, position: 'top', labels: { usePointStyle: true, boxWidth: 8, font: { family: "'Inter', sans-serif", size: 11, weight: '500' } } }, 
                            tooltip: { backgroundColor: 'rgba(15, 23, 42, 0.9)', padding: 12, cornerRadius: 8, callbacks: { label: (ctx) => `${ctx.dataset.label}: ${ctx.raw}%` } } 
                        } 
                    }
                });
                
                const trendCtx = document.getElementById('trendLineChart').getContext('2d');
                const gradientFill = trendCtx.createLinearGradient(0, 0, 0, 300);
                gradientFill.addColorStop(0, 'rgba(99, 102, 241, 0.4)'); 
                gradientFill.addColorStop(1, 'rgba(99, 102, 241, 0.0)');

                trendLineChart = new Chart(trendCtx, {
                    type: 'line',
                    data: {
                        labels: trendLabels,
                        datasets: [{
                            label: 'Marks Trend',
                            data: [],
                            borderColor: 'rgba(99, 102, 241, 1)',
                            backgroundColor: gradientFill,
                            borderWidth: 3,
                            pointBackgroundColor: '#fff',
                            pointBorderColor: 'rgba(99, 102, 241, 1)',
                            pointBorderWidth: 2,
                            pointRadius: 4,
                            pointHoverRadius: 6,
                            fill: true,
                            tension: 0.4 
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        scales: {
                            x: { grid: { display: false }, ticks: { font: { size: 11, weight: '500' }, color: '#64748b' } },
                            y: { 
                                beginAtZero: true, 
                                suggestedMax: 15,
                                grid: { color: 'rgba(0,0,0,0.05)', drawBorder: false }, 
                                ticks: { font: { size: 12, weight: '600' }, color: '#64748b', stepSize: 3 } 
                            }
                        },
                        plugins: {
                            legend: { display: false },
                            tooltip: {
                                backgroundColor: 'rgba(15, 23, 42, 0.9)',
                                titleFont: { size: 13, family: "'Inter', sans-serif" },
                                bodyFont: { size: 14, weight: 'bold' },
                                padding: 12,
                                cornerRadius: 8,
                                displayColors: false,
                                callbacks: { label: (ctx) => `${ctx.raw} Marks` }
                            }
                        }
                    }
                });
            } catch(e) {
                console.warn('Charts failed to load properly:', e);
            }
        }

        function updateMetricsAndCharts() {
            const subjectProgress = {};
            const subjectTotals = {};
            const subjectPhaseProgress = {}; 
            
            for (const subject in syllabus) {
                const subjectId = subject.replace(/\s+/g, '-').toLowerCase();
                subjectProgress[subjectId] = 0;
                subjectTotals[subjectId] = syllabus[subject].length * columns.length;
                subjectPhaseProgress[subjectId] = { notes: 0, practice: 0, revision: 0 };
            }

            let totalChecked = 0;
            let revisionsDone = 0;
            let completedTopicCount = 0;

            const allCheckboxes = document.querySelectorAll('.custom-checkbox');
            const topicCompletionMap = {};

            allCheckboxes.forEach(cb => {
                const isChecked = checkboxStates[cb.id] || false;
                cb.checked = isChecked; 
                
                if (isChecked) {
                    totalChecked++;
                    const subjectId = cb.dataset.subject;
                    if (subjectId) {
                        subjectProgress[subjectId]++;
                        
                        if (cb.id.includes('-notes')) {
                            subjectPhaseProgress[subjectId].notes++;
                        } else if (cb.id.includes('-tt') || cb.id.includes('-pyq1') || cb.id.includes('-pyq2')) {
                            subjectPhaseProgress[subjectId].practice++;
                        } else if (cb.id.includes('-r1') || cb.id.includes('-r2') || cb.id.includes('-r3')) {
                            subjectPhaseProgress[subjectId].revision++;
                            revisionsDone++;
                        }
                    }
                }

                const topicBaseId = cb.id.substring(0, cb.id.lastIndexOf('-'));
                if (!topicCompletionMap[topicBaseId]) topicCompletionMap[topicBaseId] = { total: 0, checked: 0 };
                topicCompletionMap[topicBaseId].total++;
                if (isChecked) topicCompletionMap[topicBaseId].checked++;
            });

            Object.values(topicCompletionMap).forEach(topic => {
                if (topic.checked === topic.total) completedTopicCount++;
            });

            const subjectPercentages = [];
            let subjectsMastered = 0;
            let totalProjectedScore = 0;
            
            const notesData = [];
            const practiceData = [];
            const revisionData = [];

            for (const subject in syllabus) {
                const subjectId = subject.replace(/\s+/g, '-').toLowerCase();
                const percentage = subjectTotals[subjectId] > 0 ? Math.round((subjectProgress[subjectId] / subjectTotals[subjectId]) * 100) : 0;
                subjectPercentages.push(percentage);
                
                const weight = subjectWeightages[subject] || 0;
                totalProjectedScore += (percentage / 100) * weight;
                
                const totalTopics = syllabus[subject].length;
                const nVal = totalTopics > 0 ? Math.round((subjectPhaseProgress[subjectId].notes / totalTopics) * 14.28) : 0;
                const pVal = totalTopics > 0 ? Math.round((subjectPhaseProgress[subjectId].practice / (totalTopics * 3)) * 42.86) : 0;
                const rVal = totalTopics > 0 ? Math.round((subjectPhaseProgress[subjectId].revision / (totalTopics * 3)) * 42.86) : 0;
                
                notesData.push(nVal);
                practiceData.push(pVal);
                revisionData.push(rVal);
                
                const progressBar = document.getElementById(`progress-${subjectId}`);
                const progressText = document.getElementById(`progress-text-${subjectId}`);
                const icon = document.getElementById(`icon-${subjectId}`);
                const folderIcon = document.querySelector(`#icon-${subjectId} + .folder-icon`);
                
                if (progressBar && progressText) {
                    progressBar.style.width = `${percentage}%`;
                    progressText.textContent = `${percentage}%`;
                    
                    if (percentage === 100) {
                        if (!subjectCompletionState[subjectId]) subjectsMastered++;
                        icon.classList.remove('opacity-0', 'scale-50');
                        icon.classList.add('opacity-100', 'scale-100');
                        folderIcon.classList.add('opacity-0', 'scale-50', 'absolute');
                        
                        if (!subjectCompletionState[subjectId]) {
                            try {
                                if (typeof confetti !== 'undefined') {
                                    confetti({ particleCount: 100, spread: 70, origin: { y: 0.6 }, colors: ['#6366f1', '#a855f7', '#3b82f6'] });
                                }
                            } catch(e) {}
                            subjectCompletionState[subjectId] = true;
                        }
                    } else {
                        icon.classList.add('opacity-0', 'scale-50');
                        icon.classList.remove('opacity-100', 'scale-100');
                        folderIcon.classList.remove('opacity-0', 'scale-50', 'absolute');
                        subjectCompletionState[subjectId] = false;
                    }
                }
            }
            
            subjectsMastered = subjectPercentages.filter(p => p === 100).length;

            const overallPercentage = totalCheckboxes > 0 ? Math.round((totalChecked / totalCheckboxes) * 100) : 0;
            document.getElementById('overall-progress').style.width = `${overallPercentage}%`;
            document.getElementById('overall-progress-text').textContent = `${overallPercentage}%`;
            
            document.getElementById('metric-total-completion').textContent = `${overallPercentage}%`;
            document.getElementById('metric-projected-score').textContent = totalProjectedScore % 1 === 0 ? totalProjectedScore : totalProjectedScore.toFixed(1);
            document.getElementById('metric-topics-completed').textContent = completedTopicCount;
            document.getElementById('metric-revisions-done').textContent = revisionsDone;

            if (radarChart && barChart) {
                radarChart.data.datasets.data = subjectPercentages;
                barChart.data.datasets.data = notesData;
                barChart.data.datasets.data = practiceData;
                barChart.data.datasets.data = revisionData;
                radarChart.update();
                barChart.update();
            }
        }

        async function handleCheckboxChange(e) {
            if (e.target.classList.contains('custom-checkbox') && currentUser) {
                const id = e.target.id;
                checkboxStates[id] = e.target.checked;
                updateMetricsAndCharts(); 
                
                try {
                    localStorage.setItem(LOCAL_STORAGE_KEY, JSON.stringify(checkboxStates));
                } catch(err) { console.warn("Failed to write to localStorage"); }
                
                if (navigator.onLine) {
                    try {
                        await setDoc(getUserDocRef(currentUser.uid), { data: checkboxStates }, { merge: true });
                    } catch (err) {
                        console.error("Cloud save failed.", err);
                    }
                }
            }
        }

        function setupFirestoreListener(userId) {
            if (unsubscribe) unsubscribe();
            
            unsubscribe = onSnapshot(getUserDocRef(userId), (docSnap) => {
                if (docSnap.exists() && docSnap.data().data) {
                    checkboxStates = docSnap.data().data;
                    try {
                        localStorage.setItem(LOCAL_STORAGE_KEY, JSON.stringify(checkboxStates));
                    } catch(err) {}
                } else {
                    let localData = null;
                    try { localData = localStorage.getItem(LOCAL_STORAGE_KEY); } catch(err){}
                    if (!localData) {
                        checkboxStates = {};
                    }
                }
                updateMetricsAndCharts();
            }, (error) => {
                console.error("Firestore listener error:", error);
            });
        }

        const networkStatusBadge = document.getElementById('network-status');
        
        async function handleConnectionChange() {
            if (navigator.onLine) {
                networkStatusBadge.classList.add('hidden');
                if (currentUser) {
                    let localData = null;
                    try { localData = localStorage.getItem(LOCAL_STORAGE_KEY); } catch(err){}
                    
                    if (localData) {
                        try {
                            const parsedData = JSON.parse(localData);
                            await setDoc(getUserDocRef(currentUser.uid), { data: parsedData }, { merge: true });
                        } catch (e) {
                            console.error("Auto-sync failed", e);
                        }
                    }
                }
            } else {
                networkStatusBadge.classList.remove('hidden');
            }
        }

        window.addEventListener('online', handleConnectionChange);
        window.addEventListener('offline', handleConnectionChange);
        handleConnectionChange(); 

        // --- PROGRESSIVE WEB APP (PWA) INJECTION ---
        // Safely injecting only the manifest to prevent Blob SW crashes
        try {
            const svgIcon = `<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 100 100"><text y=".9em" font-size="90">üèÜ</text></svg>`;
            const iconUrl = 'data:image/svg+xml;base64,' + btoa(unescape(encodeURIComponent(svgIcon)));
            
            const manifest = {
                name: "GATE CSE Tracker",
                short_name: "GATE Tracker",
                description: "Master the GATE CSE syllabus systematically.",
                start_url: location.href,
                display: "standalone",
                background_color: "#f8fafc",
                theme_color: "#4f46e5",
                icons: [{
                    src: iconUrl,
                    sizes: "192x192 512x512",
                    type: "image/svg+xml"
                }]
            };
            
            const manifestBlob = new Blob([JSON.stringify(manifest)], {type: 'application/json'});
            const link = document.createElement('link');
            link.rel = 'manifest';
            link.href = URL.createObjectURL(manifestBlob);
            document.head.appendChild(link);
        } catch(e) {
            console.warn("PWA manifest bypass", e);
        }

        // --- AUTHENTICATION & BOOTSTRAP ---
        const authScreen = document.getElementById('auth-screen');
        const initialLoader = document.getElementById('initial-loader');
        const authCard = document.getElementById('auth-card');
        const appContainer = document.getElementById('app-container');
        const userProfileImgContainer = document.getElementById('user-profile-img-container');

        // Immediately build the core UI
        generateSyllabusHTML();
        generateMarksTable();
        initCharts();
        initTrendAnalytics();
        container.addEventListener('change', handleCheckboxChange);
        
        // Fast Boot: Recover local storage without crashing
        try {
            const cachedData = localStorage.getItem(LOCAL_STORAGE_KEY);
            if (cachedData) {
                checkboxStates = JSON.parse(cachedData);
                updateMetricsAndCharts();
            }
        } catch(e) {
            console.warn("Local storage blocked/failed");
        }

        // Setup Firebase Auth State tracking
        onAuthStateChanged(auth, (user) => {
            if (user) {
                currentUser = user;
                
                authScreen.classList.add('opacity-0');
                setTimeout(() => {
                    authScreen.classList.add('hidden');
                    appContainer.classList.remove('hidden');
                }, 500);

                const photo = user.photoURL || `https://ui-avatars.com/api/?name=${user.displayName || 'U'}&background=e0e7ff&color=4f46e5`;
                const name = user.displayName || 'Student';
                
                userProfileImgContainer.innerHTML = `
                    <img src="${photo}" alt="User" class="w-10 h-10 rounded-full border-2 border-white shadow-sm object-cover">
                    <svg class="w-4 h-4 text-slate-400 ml-1" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"/></svg>
                `;
                document.getElementById('dropdown-user-name').textContent = name;
                
                setupFirestoreListener(user.uid);
            } else {
                currentUser = null;
                initialLoader.classList.add('hidden');
                authCard.classList.remove('hidden');
                authScreen.classList.remove('hidden', 'opacity-0');
                appContainer.classList.add('hidden');
                if (unsubscribe) unsubscribe();
            }
        });

        document.getElementById('login-btn').addEventListener('click', async () => {
            const btn = document.getElementById('login-btn');
            const orig = btn.innerHTML;
            btn.innerHTML = `<div class="w-5 h-5 border-2 border-slate-400 border-t-slate-700 rounded-full animate-spin"></div>`;
            btn.disabled = true;
            try {
                await signInWithPopup(auth, provider);
            } catch (err) {
                alert("Sign-in failed.");
                btn.innerHTML = orig;
                btn.disabled = false;
            }
        });

        // --- UI LOGIC ---
        const profileTrigger = document.getElementById('user-profile-trigger');
        const profileDropdown = document.getElementById('profile-dropdown');
        
        profileTrigger.addEventListener('click', (e) => {
            e.stopPropagation();
            profileDropdown.classList.toggle('opacity-0');
            profileDropdown.classList.toggle('pointer-events-none');
            profileDropdown.classList.toggle('scale-95');
        });

        document.addEventListener('click', (e) => {
            if (!profileTrigger.contains(e.target) && !profileDropdown.contains(e.target)) {
                profileDropdown.classList.add('opacity-0', 'pointer-events-none', 'scale-95');
            }
        });

        const tabs = [
            { btn: document.getElementById('tab-syllabus'), view: document.getElementById('syllabus-content') },
            { btn: document.getElementById('tab-dashboard'), view: document.getElementById('dashboard-content') },
            { btn: document.getElementById('tab-marks'), view: document.getElementById('marks-content') }
        ];

        function switchTab(activeBtnId) {
            tabs.forEach(tab => {
                if (tab.btn.id === activeBtnId) {
                    tab.btn.className = "flex-1 md:flex-none whitespace-nowrap text-sm font-semibold py-2.5 px-6 rounded-lg bg-white text-brand-600 shadow-sm transition-all duration-200";
                    tab.view.classList.remove('hidden');
                } else {
                    tab.btn.className = "flex-1 md:flex-none whitespace-nowrap text-sm font-semibold py-2.5 px-6 rounded-lg text-slate-500 hover:text-slate-700 hover:bg-white/50 transition-all duration-200";
                    tab.view.classList.add('hidden');
                }
            });
        }

        document.getElementById('tab-syllabus').addEventListener('click', () => switchTab('tab-syllabus'));
        document.getElementById('tab-dashboard').addEventListener('click', () => switchTab('tab-dashboard'));
        document.getElementById('tab-marks').addEventListener('click', () => switchTab('tab-marks'));

        const btnAvg = document.getElementById('toggle-average');
        const btnMed = document.getElementById('toggle-median');
        
        btnAvg.addEventListener('click', () => {
            currentMarksMetric = 'average';
            btnAvg.className = "px-4 py-1.5 text-sm font-semibold rounded-lg bg-white text-brand-600 shadow-sm transition-all duration-200";
            btnMed.className = "px-4 py-1.5 text-sm font-semibold rounded-lg text-slate-500 hover:text-slate-700 transition-all duration-200";
            generateMarksTable();
        });
        
        btnMed.addEventListener('click', () => {
            currentMarksMetric = 'median';
            btnMed.className = "px-4 py-1.5 text-sm font-semibold rounded-lg bg-white text-purple-600 shadow-sm transition-all duration-200";
            btnAvg.className = "px-4 py-1.5 text-sm font-semibold rounded-lg text-slate-500 hover:text-slate-700 transition-all duration-200";
            generateMarksTable();
        });

        const openModal = (modalId, contentId) => {
            document.getElementById(modalId).classList.remove('opacity-0', 'pointer-events-none');
            document.getElementById(contentId).classList.remove('scale-95');
            document.getElementById(contentId).classList.add('scale-100');
        };
        
        const closeModal = (modalId, contentId) => {
            document.getElementById(modalId).classList.add('opacity-0', 'pointer-events-none');
            document.getElementById(contentId).classList.remove('scale-100');
            document.getElementById(contentId).classList.add('scale-95');
        };

        document.getElementById('reset-btn').addEventListener('click', () => {
            profileDropdown.classList.add('opacity-0', 'pointer-events-none', 'scale-95'); 
            openModal('reset-modal', 'reset-modal-content');
        });
        document.getElementById('cancel-reset').addEventListener('click', () => closeModal('reset-modal', 'reset-modal-content'));
        
        document.getElementById('confirm-reset').addEventListener('click', async () => {
            if(currentUser) {
                checkboxStates = {};
                try {
                    localStorage.removeItem(LOCAL_STORAGE_KEY);
                } catch(err) {}
                
                await setDoc(getUserDocRef(currentUser.uid), { data: {} });
                updateMetricsAndCharts();
            }
            closeModal('reset-modal', 'reset-modal-content');
        });

        document.getElementById('guide-btn').addEventListener('click', () => {
            profileDropdown.classList.add('opacity-0', 'pointer-events-none', 'scale-95');
            openModal('guide-modal', 'guide-modal-content');
        });
        document.getElementById('close-guide').addEventListener('click', () => closeModal('guide-modal', 'guide-modal-content'));
        document.getElementById('got-it-btn').addEventListener('click', () => closeModal('guide-modal', 'guide-modal-content'));

        document.getElementById('logout-btn').addEventListener('click', () => signOut(auth));

    </script>
</body>
</html>